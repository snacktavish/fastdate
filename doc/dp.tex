% This is LLNCS.DEM the demonstration file of
% the LaTeX macro package from Springer-Verlag
% for Lecture Notes in Computer Science,
% version 2.4 for LaTeX2e as of 16. April 2010
%
\documentclass{llncs}
%
\usepackage{amsmath}
\usepackage{amssymb}

\newcounter{instr}
\newcommand{\ninstr}{\refstepcounter{instr}\theinstr.}

\newcommand{\ejmcomment}[1]{{\color{green} #1}}
\usepackage{hyperref}
\hypersetup{backref,  linkcolor=blue, citecolor=red, colorlinks=true, hyperindex=true}

\begin{document}

\title{A dynamic programming approach for speed-dating}

\titlerunning{Speed dating}

\author{Tom\'{a}\v{s} Flouri\inst{1}, Emily Jane McTavish\inst{1}, Author, Author, Author}
\authorrunning{Tom\'{a}\v{s} Flouri et al.} % abbreviated author list
\institute{Heidelberg Institute of Theoretical Studies\\
\email{Tomas.Flouri@h-its.org}}

\maketitle
%%for the moment writing up as targeted for sys bio software paper
\begin{abstract} We present a dynamic programming algorithm to rapidly
ultrametricize even very large phylogenies, implemented in the open source software package FastDate. 
This software is \ejmcomment{(will be)} capable of using node or tip dating information to scale trees to absolute time,
or estimate relative time information.
We have implemented recent developments in probabilities of trees accounting for both incomplete 
sampling of species in the present day, and the sampling in the past due to the fossilization and recovery processes.
FastDate is \ejmcomment{(will be)} available on our webserver and on github.
\end{abstract}


\section{Introduction}
As it is becoming possible to reconstruct very large phylogenies, 
researchers are interested in using these phylogenies for downstream analyses.
However, most phylogenetic analysis software provides trees with branch lengths in units of expected number of substitutions per site,
whereas downstream analyses may divergence times in years.
For many questions, such as comparisons of rates of speciation in different groups, it is necessary to have an ultrametric tree.
Phylogeographic or paleontological questions estimates in absolute time,
in order to associate evolutionary events with historical ones.

TODO Paragraph on utility of dated trees.

TODO Explanation of Akerborg GSR and other previous approaches
 \cite{Akerborg2008}

TODO Better background on branch rate distributions\\
Setting dates on a tree requires factorizing the branch lengths of an input topology
from estimates of evolutionary distances into rates and times. 
An appropriate expectation for the variation in these branch rates is difficult to select.
A common approximation is to treat branch rates as gamma distributed (REF NEEDED)

BD process background:\\
Phylogenetic trees are commonly modeled using the the constant rate birth\textendash death process (Kendall,
1948).
The tree shape is parameterized using simply a per lineage birth rate ($\lambda$) and a per lineage death rate ($\mu$).
$\lambda$ must be greater than $\mu$ or the process deterministically goes to extinction.
Recent work by Gernhard (2008) and Stadler (2009, 2010) has expanded on Kendall's basic 
formulation of the probabilities of birth\textendash death trees to incorporate several important aspects of sampling:
the effect on branch lengths of truncating the process by sampling tips at the present (Gernhard 2008),
the effect of incomplete sampling of tips at the present day (Stadler 2009), and the effect of the sampling
of fossils on recovery of ancestral taxa (Stadler 2010).
Stadler (2010, theorem 3.11) gives probability of a dated topology with $n$ leaves,
under the birth\textendash death process, with some proportion of currently sampled tips ($\rho$), a rate of recovery of taxa in the past ($\psi$),
and the standard birth and death rate parameters.


\section{Algorithm}
FastDate is based on an dynamic programming adapted from that of Akerborg \cite{Akerborg2008},.
The granularity of the dating approach can be determined by the user choosing the number of time intervals to which 
nodes can be assigned.
In short, the algorithm maximizes probability of the overall tree using \cite{Stadler2010} 's probability of sampled trees with defined node heights,
by building up a table of node height values which maximize the likelihood of the node height ($\lambda p_1(t)$), 
and the likelihood of branch lengths in the tree having a given rate based on the gamma distribution $g(r)$.

The full procedure is described in depth below.


\subsection{Basic definitions}

A tree $T=(V,E)$ is a connected acyclic graph where $V$ is the set of {\em
nodes} and $E$ the set of {\em edges}, such that $E = V\times V$. We use the
notation $(u,v) \in E$ to denote an edge with end-points $u,v \in V$. If $T$ is
{\em oriented}, then {\em in-degree} (resp. {\em out-degree}) of a node denotes
the number of incoming (resp. outgoing edges) of $u$. In the opposite case, the
{\em degree} of node $u$ denotes the number of edges $u$ is an end-point of.
Further, we denote with $T_u$ the subtree of $T$ rooted at node $u$.  A {\em
rooted binary tree} $T$ is a {\em directed} tree with all nodes having
in-degree 1 and out-degree 1 ({\em inner} nodes), or in-degree 1 and out-degree
0 ({\em leaves}). Furthermore, one node has in-degree 0 and out-degree 2 ({\em
root}).  In the rest of the text we implicitly assume under the term tree a
binary rooted tree.  We denote the set of leaves of tree $T$ as $L(T)$.  The
cardinality of a set $X$ is denoted as $|X|$. The {\em height} $h(u)$ of a node
$u$ of $T$ is defined as 
%
\[ h(u) = \left\{ \begin{array}{ll}
\max(h(v), h(w)) + 1 & \quad : \quad u \notin L(T)\\
1                    & \quad : \quad u    \in L(T)\\
\end{array}\right. \] 
The height $h(T)$ of a tree $T$ is the height of its root.: Finally, we will
implicitly use the notation $\ell_{u,v}$ for the length of edge $(u,v)$.

\subsection{Branch rate distribution}
\subsection{Gamma function, Gamma distribution}

The {\em Gamma function} is an extension to the factorial function to handle
any real or complex number as argument. For point $t$ it is defined as
$$\Gamma(t) = \int_0^\infty x^{t-1} e^{-x} dx.$$

The {\em probability density function} in the shape-rate parameterization of a
{\em gamma distribution} given the {\em mean} $\bar{r}$ and variance $\sigma$ is
$$ g(x;\alpha,\beta) = \frac{\beta^{\alpha}x^{a-1}e^{-x\beta}}{\Gamma(\alpha)} $$

where $\beta = \bar{r} / \sigma$ and $\alpha = \bar{r} \beta$.
\ejmcomment{I re-labeled this with $\bar{r}$ for the mean of the gamma prior to avoid confusion with $\mu$ for birth rate.}

Its natural logarithm can be computed as
$$ \ln g(x;\alpha,\beta) = \alpha\ln\beta + (\alpha-1)\ln x -x\beta - \ln\Gamma(\alpha) $$

\subsection{Birth-death process}
From 3.11 in Stadler 2010 \textit{The probability density of a sampled tree T with n
extant sampled leaves, m extinct sampled leaves, $n+m > 0$, and $k \geq 0$
sampled individuals with sampled descendants, conditioned on
sampling n present day individuals is,}

$$F[T|n] = \frac{4n\rho\lambda\psi^{k+m}}{c_1(c_2+1)(1-c_2+(1+c_2)e^{c_1x_1})}\prod_{i=1}^{n+m-1}\lambda p_1(x_i)\prod_{i=1}^{m}\frac{p_0(y_i)}{p_1(y_i)}$$
N.B. There is a typo in this equation in \cite{Stadler2010} but logic and Stadler say that last term in denominator is $e^{c_1x_1}$ not  $e^{c_1x}$ \\

\begin{enumerate}
\item[$\lambda$]  is the per lineage birth (speciation) rate
\item[$\mu$]  is the per lineage death (extinction) rate
\item[$\psi$]  is the per lineage rate of sampling in the past (e.g. fossils) (in same units as $\lambda$ and $\mu$).
\item[$\rho$ ] is the proportion of total extant descendants $N$ which are sampled $n$.
\item[$n$] is the number of extant (current) sampled descendants of a node.
\item[$m$] is the number of extinct (fossil) sampled descendants of a node.
\item[$c_1,c_2$]  are useful constants.
$$c_1 = |\sqrt{(\lambda-\mu-\psi)^2 + 4\lambda\psi}|$$
$$c_2 = \frac{\lambda-\mu-2\lambda\rho-\psi}{c_1}$$
\end{enumerate}

$p_1(t)$ is the probability that an individual alive at time $t$ before today has precisely 1 sampled extant descendants and no sampled extinct descendants.
$${p_1}(t) = \frac{4\rho}{2(1-c_2^2)+e^{-c_1t}(1-c_2)^2+e^{c_1t}(1+c_2)^2}$$
%And with no sampled fossils ($\psi=0$)
%$$f[T|t_{mrca}=x_1,n] = n(\lambda - \mu) \frac{e^{-(\lambda-\mu)x_1}}{\rho\lambda + (\lambda(1-\rho)-\mu)e^{-(\lambda-\mu)x_1}}\prod_{i=1}^{n-1}\frac{\lambda\rho(\lambda-\mu)^2e^{-(\lambda-\mu)x_1}}{(\rho\lambda + (\lambda(1-\rho)-\mu)e^{-(\lambda-\mu)x_1})^2}$$\\

For convenience in the algorithm we refer to the first part of $F[T|n]$ as $s(t,n)$.
$$s(t,n) = \frac{4n\rho\lambda\psi^{k+m}}{c_1(c_2+1)(1-c_2+(1+c_2)e^{c_1x_1})}$$

and the second part as $p_c(v)$.
$$p_{c}(v) = \prod_{i=1}^{L(v)-1}\lambda p_1(x_i)$$
This is convenient, as we can build up the partial products of the second part of the birth death
probability density can be built up as nodes are traversed by
the dynamic programming algorithm, and stored for the calculation of $F[T|n]$ at each node.

\ejmcomment{Still need to ensure that this is actually how this simplifies out when psi=0}

\section{Dynamic programming algorithm}

We are given an integer $N \geq h(T)$ which we use to construct a grid of lines
over the height of a tree (numbered 1 to $N$), such that the (uniform) distance between any two
adjacent lines is $h(T) / N$.  Our goal is to project each node of $T$ onto one
of the $N$ using a mapping $\phi : V \mapsto \{1,\ldots,N\}$ such that the
following properties are maintained.

\begin{enumerate}
\item $\forall u,v,w \in V : (u,v), (u,w) \in E \Rightarrow \phi(u) > \phi(v) \wedge \phi(u) > \phi(w)$,
\item $\phi(u) = 1, \forall u \in L(T)$,
\end{enumerate}

Property 1 ensures that no node $v$ in the subtree rooted at $u$ is placed on
line $\phi(v) \geq \phi(u)$. Property 2 maps all leaves to the first line (line 1).
\ejmcomment{Not true in case of tip dating, but still currently true. 
Also - we have some inconsistency on whether they are mapped to line 0 or 1.
In the code it is 1 currently.}

The mapping is computed by maximizing a function, which defines a
dynamic programming algorithm.  We briefly explain the algorithm informally.

The DP uses a post-order traversal of the target tree. For each node $u$, it
computes the maximal value $f(u,t)$ for each line $t$ that node $u$ is allowed to be
placed on, along with all the lines that its two children are allowed to placed
on. This maximal value is then stored in a table along with the positions (lines) its
two children were placed on. 

We first need to set the interval of lines (discretization) that a specific
node can be placed on.  This interval (denoted $d(u)$) for node $u$ is defined
as $$ d(u) = \{ x\ |\  h(u) \leq x \leq N - (h(r) - h(u))\}.$$  This is
justified by the fact that the farthest {\em path} leading from node $u$ to a
leaf is of size $h(u)$ and contains exactly $h(u)$ nodes including $v$.
Therefore, even if all nodes in the distinct height in the subtree rooted at
$u$ are placed on distinct discretization, the lowest line that $u$ can be
placed on is line $h(u)$.

Next, we define the maximization function $f$ that is computed for each node $u \in
V\setminus L(T)$ and for each discretization line $t_u$:  
$$f(u,t_u) = \lambda p_1(t_u) \hat{f}_v \hat{f}_w $$\\ 
where $t_u \in d(u)$, $t_v \in d(v)$, $t_w \in
d(w)$.
$\hat{f}_v$ is the maximum product of $g(r_{u,w})$ and $p_c(w,t_w)$
over the possible positions of node v given the placement of u.

Therefore the full value being maximized at each discretization line for the node $u$
is 
$$f(u,t_u) = \lambda p_1(t_u) p_c(v,t_v) g(r_{u,v}) p_c(w,t_w) g(r_{u,w})$$
rearranged
$$f(u,t_u) = \lambda p_1(t_u) p_c(v,t_v)  p_c(w,t_w) g(r_{u,v}) g(r_{u,w})$$
simplified
$$f(u,t_u) = p_c(t_u) g(r_{u,v}) g(r_{u,w})$$

To calculate the position of the root (node $r$) it is necessary to maximize the
full birth death process probabilities the branch rate probabilities.
$$f(r,t_r) \leftarrow s(r,n) p_c(t_{r}) \hat g(r_{r,v}) \hat g(r_{r,w})$$

\ejmcomment{and that last term is already maximized - proof to come}

To incorporate priors on node times (e.g. from fossil calibrations)
requires only adding a term to $f(u,t_u)$ that weights the prior probability of 
node $u$ being placed on line $t_u$, $Pr(u,t_u)$

With node priors:
$$f(u,t_u) = p_c(t_u) g(r_{u,v}) g(r_{u,w}) Pr(u,t_u)$$

Tip dating changes the assignments of node heights, and therefore 
the set of potential discretization lines on which nodes can be placed,
but does not otherwise affect the algorithm.

Once the optimal position of the root has been determined,
then backtracking through maximal values stored for the 
left and right children will give a fully specified dated tree.


Fig.~\ref{fig:dp} describes the algorithm in detail.


\setcounter{instr}{0}
\begin{figure}[t]
\begin{center}
\begin{tabular}{|rl|}
\hline
\multicolumn{2}{|l|}{\textsc{DP}$(T, N, u)$}\\
\ninstr & $v \leftarrow$ left child of $u$\\
\ninstr & $w \leftarrow$ right child of $u$\\
\ninstr & $r \leftarrow$ the root of $T$\\
\ninstr & $p_1(t)$ probability that a tip at time t has 1 extant descendant from Stadler 2010  \\
\ninstr & \textbf{if} $v \in L(T)$ \textbf{then}\\
\ninstr & \qquad $M(v,1) \leftarrow 1$\\
\ninstr & \qquad $p_c(v,t_v) \leftarrow 1$\\ 
\ninstr & \qquad \textbf{return}\\
\ninstr & \textsc{DP}(T,N,v)\\        
\ninstr & \textbf{if} $w \in L(T)$ \textbf{then}\\
\ninstr & \qquad $M(w,1) \leftarrow 1$\\
\ninstr & \qquad $p_c(w,t_w) \leftarrow 1$\\ 
\ninstr & \qquad \textbf{return}\\
\ninstr & \textsc{DP}(T,N,w)\\        
\ninstr & \textbf{for} $t_u \leftarrow \min d(u)$ \textbf{to} $\max d(u)$ \\
\ninstr & \qquad $\hat{f}_u \leftarrow 0, \hat{t}_v \leftarrow 0, \hat{t}_w \leftarrow 0$\\
\ninstr & \qquad \textbf{for} $t_v \leftarrow \min d(v)$ \textbf{to} $\min\{\max d(v), t_u\}$ \\
\ninstr & \qquad \qquad  $r_{u,v} \leftarrow \ell_{u,v}/(t_u - t_v)$ \\
\ninstr & \qquad \qquad  \textbf{if} $g(r_{u,v})  p_c(v,t_v) > \hat{f}_v$ \textbf{then} \\
\ninstr & \qquad \qquad \qquad $\hat{f}_v \leftarrow g(r_{u,v})  p_c(v,t_v)$\\
\ninstr & \qquad \qquad \qquad $\hat{g}_v \leftarrow g(r_{u,v})$\\
\ninstr & \qquad \qquad \qquad $\hat t_v \leftarrow t_v$\\
\ninstr & \qquad \qquad \qquad $\hat p_{cv} \leftarrow p_c(v,t_v)$\\
\ninstr & \qquad \textbf{for} $t_w \leftarrow \min d(w)$ \textbf{to} $\min\{\max d(w), t_u\}$ \\
\ninstr & \qquad \qquad  $r_{u,w} \leftarrow \ell_{u,w}/(t_u - t_w)$\\
\ninstr & \qquad \qquad  \textbf{if} $g(r_{u,w})  p_c(v,t_w) > \hat{f}_w$ \textbf{then} \\
\ninstr & \qquad \qquad \qquad $\hat{f}_w \leftarrow g(r_{u,w})  p_c(w,t_w)$\\
\ninstr & \qquad \qquad \qquad $\hat{g}_w \leftarrow g(r_{u,w})$\\
\ninstr & \qquad \qquad \qquad $\hat t_w \leftarrow t_w$\\
\ninstr & \qquad \qquad \qquad $\hat p_{cw} \leftarrow p_c(w,t_w)$\\
\ninstr & \qquad $p_{c}(u,t_u) \leftarrow \hat p_{cv} \hat p_{cw} \lambda p_1(t_u)$  \\
\ninstr & \qquad \textbf{if} $u == r$  \textbf{then}\\
\ninstr & \qquad \qquad $f(u,t_u) \leftarrow s(u,n_{u}) p_c(t_{u}) \hat g(r_{u,v}) \hat g(r_{u,w})$ \\
\ninstr & \qquad \textbf{else} \\
\ninstr & \qquad \qquad $f(u,t_u) \leftarrow p_c(t_{u}) \hat g(r_{u,v}) \hat g(r_{u,w})$ \\
\ninstr & \qquad \textbf{if} $f(u,t_u) > \hat{f}_u$ \textbf{then} \\
\ninstr & \qquad \qquad $\hat{f}_u \leftarrow f(u,t)$\\
\ninstr & \qquad $M(u,t_u) \leftarrow \hat{f}_u, M^l(u,t_u) \leftarrow \hat{t}_v, M^r(u,t_u) \leftarrow \hat{t}_w$  \\



\hline  
\end{tabular}
\end{center}
\caption{The DP algorithm for computing relative divergence times. The
algorithm starts by passing the tree ($T$), number of discretization lines
($N$) and the root of $T$ ($u$). It recursively traverses the tree in
postorder and then computes the best placement for every node $u$.}
\label{fig:dp}
\end{figure}

\section{Description of software}
FastDate requires as input a fully bifurcating rooted phylogeny with branch lengths,
and user defined estimates of birth rate ($\lambda$), death rate ($\mu$), 
and proportion of descendants of the most recent common ancestor of the taxa found in the tree
which were sampled in the tree ($\rho$).
Optional parameters include $\psi$ the rate of recovery of fossils per lineage.



\section{Example}
\subsection{Node dating example from 1 KITE}

\subsection{Tip dating example from Stadler and Yang}

\section{Discussion}


\bibliographystyle{splncs03}
\bibliography{dating}
\end{document}
